name: Build macOS Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0-macos'

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    name: Build macOS Application
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set version from release tag
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          # Extract version from release tag (e.g., "v1.0.0" from tag "v1.0.0")
          VERSION="${{ github.event.release.tag_name }}"
        else
          # For workflow_dispatch, use the input version
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "Setting version to: $VERSION"
        echo "$VERSION" > VERSION
        cat VERSION
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Display Python version
      run: python --version
      
    - name: Install system dependencies for icon generation
      run: |
        brew install imagemagick
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements_macos.txt
        # Verify critical dependencies (same checks as local_build.sh; fail early on missing packages)
        MISSING=""
        for pkg in webrtcvad-wheels pyinstaller torch gradio pywebview; do
          if ! python -m pip show "$pkg" &>/dev/null; then
            MISSING="${MISSING} ${pkg}"
          fi
        done
        if [ -n "$MISSING" ]; then
          echo "::error::Missing package(s):$MISSING"
          exit 1
        fi
        echo "Critical packages present (webrtcvad-wheels, pyinstaller, torch, gradio, pywebview)"

    - name: Generate app icon
      run: |
        chmod +x build/macos/generate_icon.sh
        PYTHON=python ./build/macos/generate_icon.sh

    - name: Check build/macos assets (icon, codesign, DMG README)
      run: |
        if [ ! -f "build/macos/Applio.icns" ]; then
          echo "::error::build/macos/Applio.icns not found after generation."
          exit 1
        fi
        if [ ! -f "build/macos/codesign.sh" ]; then
          echo "::error::build/macos/codesign.sh not found."
          exit 1
        fi
        if [ ! -f ".github/DMG_README.txt" ]; then
          echo "::error::.github/DMG_README.txt not found."
          exit 1
        fi

    - name: Clean previous PyInstaller outputs
      run: |
        rm -rf dist/Applio.app build/Applio

    - name: Build with PyInstaller
      run: |
        python -m PyInstaller Applio.spec --clean --noconfirm

    - name: Set up app bundle executable
      run: |
        # CFBundleExecutable is "Applio"; PyInstaller produces Applio_bin
        # Copy so the app runs the real binary (native, no terminal)
        cp dist/Applio.app/Contents/MacOS/Applio_bin dist/Applio.app/Contents/MacOS/Applio
        chmod +x dist/Applio.app/Contents/MacOS/Applio
        
    - name: Code sign the app bundle
      run: |
        # Run the code signing script with ad-hoc signing (no certificate required for dev builds)
        # This prevents the "app is damaged" warning that requires sudo xattr -cr
        # For production releases, set MACOS_SIGNING_IDENTITY secret to your Developer ID
        chmod +x build/macos/codesign.sh
        ./build/macos/codesign.sh dist/Applio.app
      env:
        MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY || '-' }}
        
    - name: Create DMG (macOS disk image)
      run: |
        # Create a temporary directory for DMG contents
        mkdir -p dmg_temp
        cp -R dist/Applio.app dmg_temp/
        
        # Copy the .command file for easy launching
        cp Applio.command dmg_temp/
        chmod +x dmg_temp/Applio.command
        
        # Create Applications symlink for easy drag-and-drop install
        ln -s /Applications dmg_temp/Applications
        
        # Copy README for users
        cp .github/DMG_README.txt dmg_temp/README.txt
        
        # Create DMG
        hdiutil create -volname "Applio" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          Applio-macOS.dmg
          
    - name: Create ZIP archive (alternative distribution)
      run: |
        cd dist
        zip -r ../Applio-macOS.zip Applio.app
        cd ..
        
    - name: Calculate checksums
      run: |
        shasum -a 256 Applio-macOS.dmg > checksums.txt
        shasum -a 256 Applio-macOS.zip >> checksums.txt
        cat checksums.txt
        
    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: Applio-macOS-DMG
        path: Applio-macOS.dmg
        
    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: Applio-macOS-ZIP
        path: Applio-macOS.zip
        
    - name: Upload to Release (if triggered by release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Applio-macOS.dmg
          Applio-macOS.zip
          checksums.txt
          
    - name: Check if release exists (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      id: check_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "Checking if release exists for version: $VERSION"
        
        # Set up cleanup trap
        trap 'rm -f /tmp/release_check.json' EXIT
        
        # Validate version format (basic check for tag-like format)
        if [[ ! "$VERSION" =~ ^[a-zA-Z0-9v._-]+$ ]]; then
          echo "::error::Invalid version format: $VERSION"
          echo "Version should only contain alphanumeric characters, 'v', '.', '_', or '-'"
          exit 1
        fi
        
        # Use GitHub API to check if release exists
        HTTP_CODE=$(curl -s -o /tmp/release_check.json -w "%{http_code}" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION")
        CURL_EXIT=$?
        
        # Check for curl errors
        if [ $CURL_EXIT -ne 0 ]; then
          echo "::error::Failed to query GitHub API (curl exit code: $CURL_EXIT)"
          exit 1
        fi
        
        # Validate HTTP_CODE is numeric
        if ! [[ "$HTTP_CODE" =~ ^[0-9]+$ ]]; then
          echo "::error::Invalid HTTP response code: $HTTP_CODE"
          exit 1
        fi
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "Release $VERSION exists"
          echo "release_exists=true" >> $GITHUB_OUTPUT
        elif [ "$HTTP_CODE" -eq 404 ]; then
          echo "Release $VERSION does not exist (HTTP 404)"
          echo "release_exists=false" >> $GITHUB_OUTPUT
        else
          echo "::error::Unexpected HTTP response code: $HTTP_CODE"
          echo "This may indicate authentication issues, rate limiting, or server errors."
          exit 1
        fi
        
    - name: Upload to existing release (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch' && steps.check_release.outputs.release_exists == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        files: |
          Applio-macOS.dmg
          Applio-macOS.zip
          checksums.txt
          
    - name: Log release does not exist (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch' && steps.check_release.outputs.release_exists == 'false'
      run: |
        echo "::warning::Release ${{ github.event.inputs.version }} does not exist. Skipping upload."
        echo "To create a release with this version, please create it manually or trigger the release workflow."
